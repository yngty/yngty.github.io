---
title: TCP 协议
date: 2023-07-25 09:43:58
tags:
- tcp
categories:
- Network
---

# `TCP` 基本认识
`TCP` 是 **面向连接的、可靠的、基于字节流**的传输层通信协议。




```
 0                   1                   2                   3 
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

<!--more-->
`TCP` 连接状态图

```
                              +---------+ ---------\      active OPEN  
                              |  CLOSED |            \    -----------  
                              +---------+<---------\   \   create TCB  
                                |     ^              \   \  snd SYN    
                   passive OPEN |     |   CLOSE        \   \           
                   ------------ |     | ----------       \   \         
                    create TCB  |     | delete TCB         \   \       
                                V     |                      \   \     
                              +---------+            CLOSE    |    \   
                              |  LISTEN |          ---------- |     |  
                              +---------+          delete TCB |     |  
                   rcv SYN      |     |     SEND              |     |  
                  -----------   |     |    -------            |     V  
 +---------+      snd SYN,ACK  /       \   snd SYN          +---------+
 |         |<-----------------           ------------------>|         |
 |   SYN   |                    rcv SYN                     |   SYN   |
 |   RCVD  |<-----------------------------------------------|   SENT  |
 |         |                    snd ACK                     |         |
 |         |------------------           -------------------|         |
 +---------+   rcv ACK of SYN  \       /  rcv SYN,ACK       +---------+
   |           --------------   |     |   -----------                  
   |                  x         |     |     snd ACK                    
   |                            V     V                                
   |  CLOSE                   +---------+                              
   | -------                  |  ESTAB  |                              
   | snd FIN                  +---------+                              
   |                   CLOSE    |     |    rcv FIN                     
   V                  -------   |     |    -------                     
 +---------+          snd FIN  /       \   snd ACK          +---------+
 |  FIN    |<-----------------           ------------------>|  CLOSE  |
 | WAIT-1  |------------------                              |   WAIT  |
 +---------+          rcv FIN  \                            +---------+
   | rcv ACK of FIN   -------   |                            CLOSE  |  
   | --------------   snd ACK   |                           ------- |  
   V        x                   V                           snd FIN V  
 +---------+                  +---------+                   +---------+
 |FINWAIT-2|                  | CLOSING |                   | LAST-ACK|
 +---------+                  +---------+                   +---------+
   |                rcv ACK of FIN |                 rcv ACK of FIN |  
   |  rcv FIN       -------------- |    Timeout=2MSL -------------- |  
   |  -------              x       V    ------------        x       V  
    \ snd ACK                 +---------+delete TCB         +---------+
     ------------------------>|TIME WAIT|------------------>| CLOSED  |
                              +---------+                   +---------+

```

## 如何唯一确定一个 `TCP` 连接?

**`TCP` 四元组**可以唯一的确定一个连接，四元组包括如下：

- 源地址
- 源端口
- 目的地址
- 目的端口

# `TCP` 连接建立

## 三次握手

- 防止历史连接
- 避免资源浪费
- 同步双方初始序列号

```
      TCP A                                                TCP B

  1.  CLOSED                                               LISTEN

  2.  SYN-SENT    --> <SEQ=100><CTL=SYN>               --> SYN-RECEIVED

  3.  ESTABLISHED <-- <SEQ=300><ACK=101><CTL=SYN,ACK>  <-- SYN-RECEIVED

  4.  ESTABLISHED --> <SEQ=101><ACK=301><CTL=ACK>       --> ESTABLISHED

  5.  ESTABLISHED --> <SEQ=101><ACK=301><CTL=ACK><DATA> --> ESTABLISHED
```

# 重传机制

`TCP` 针对数据包丢失的情况，会用重传机制解决。

## 超时重传

`RTT`（`Round-Trip Time` 往返时延）指的是数据发送时刻到接收到确认的时刻的差值，也就是包的往返时间。

超时重传时间是以 `RTO` （`Retransmission Timeout`）表示。

精确的测量超时时间 `RTO` 的值是非常重要的，这可让我们的重传机制更高效。

- 当超时时间 `RTO` 较大时，重发就慢，丢了老半天才重发，没有效率，性能差；
- 当超时时间 `RTO` 较小时，会导致可能并没有丢就重发，于是重发的就快，会增加网络拥塞，导致更多的超时，更多的超时导致更多的重发。


根据上述的两种情况，我们可以得知，超时重传时间 `RTO` 的值应该略大于报文往返 `RTT` 的值。因为网络也是时常变化的，所以 `RTO` 是一个动态变化的值。

每当遇到一次超时重传的时候，都会将下一次 `RTO` 设为**先前值的两倍**。两次超时，就说明网络环境差，不宜频繁反复发送。


## 快速重传

当收到三个相同的 `ACK` 报文时，会在定时器过期之前，重传丢失的报文段。快速重传机制只解决了一个问题，就是超时时间的问题，但是它依然面临着另外一个问题。就是重传的时候，是重传一个，还是重传所有的问题。为了解决不知道该重传哪些 `TCP` 报文，于是就有 `SACK` 方法。

## SACK
`SACK`（`Selective Acknowledgment`），选择性确认。在 `TCP` 头部「选项」字段里加一个 `SACK` ，它可以将已收到的数据的信息发送给 **「发送方」**，这样发送方就可以知道哪些数据收到了，哪些数据没收到，知道了这些信息，就可以 **只重传丢失的数据**。

> 在 `Linux` 下可以通过 `net.ipv4.tcp_sack` 参数开启/关闭这个功能（`Linux 2.4` 后默认打开）。


## D-SACK
`D-SACK` (`Duplicate SACK`) ，其主要使用了 `SACK` 来告诉 **「发送方」**有哪些数据被重复接收了。

`D-SACK` 有这么几个好处：

- 可以让「发送方」知道，是发出去的包丢了，还是接收方回应的 ACK 包丢了;
- 可以知道是不是「发送方」的数据包被网络延迟了;
- 可以知道网络中是不是把「发送方」的数据包给复制了;

> 在 `Linux` 下可以通过 `net.ipv4.tcp_dsack` 参数开启/关闭这个功能（`Linux 2.4` 后默认打开）。

# 滑动窗口

## 发送窗口
## 接收窗口

# 流量控制

发送方不能无脑的发数据给接收方，要考虑接收方处理能力。

如果一直无脑的发数据给对方，但对方处理不过来，那么就会导致触发重发机制，从而导致网络流量的无端的浪费。

为了解决这种现象发生，**`TCP` 提供一种机制可以让「发送方」根据「接收方」的实际接收能力控制发送的数据量，这就是所谓的流量控制。**

## 操作系统缓冲区和滑动窗口的关系
## 窗口关闭

如果窗口大小为 `0` 时，就会阻止发送方给接收方传递数据，直到窗口变为非 `0` 为止，这就是窗口关闭。

## 糊涂窗口综合症

# 拥塞控制

## 慢启动

慢启动就是一点一点的提高发送数据包的数量, **当发送方每收到一个 `ACK`，拥塞窗口 `cwnd` 的大小就会加 `1`**, 发包的个数是**指数性的增长**

- 慢启动门限 `ssthresh` （`slow start threshold`）状态变量，默认 `65535` 大小。
    - `cwnd` < `ssthresh` 时，使用**慢启动算法**。
    - `cwnd` >= `ssthresh` 时，就会使用**拥塞避免算法**。


## 拥塞避免

**每当收到一个 `ACK` 时，`cwnd` 增加 `1/cwnd`**, 发包的个数是**线性的增长**
## 拥塞发送
## 快速恢复