---
title: Makefile æ‹¾é—
date: 2025-07-31 11:18:39
tags:
- Makefile
---

## ä¸€ã€ä»€ä¹ˆæ˜¯ Makefile

`Makefile` æ˜¯ä¸º `make` å‘½ä»¤å‡†å¤‡çš„è„šæœ¬æ–‡ä»¶ï¼Œå®ƒæè¿°äº†é¡¹ç›®ä¸­æ–‡ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ä»¥åŠå¦‚ä½•ç¼–è¯‘å®ƒä»¬ã€‚å®ƒå…è®¸ä½ åªè¾“å…¥ä¸€æ¡å‘½ä»¤ `make`ï¼Œå³å¯è‡ªåŠ¨ç¼–è¯‘é¡¹ç›®ä¸­æ‰€æœ‰éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ã€‚

## äºŒã€Makefile åŸºæœ¬è¯­æ³•

æœ€åŸºæœ¬çš„æ ¼å¼å¦‚ä¸‹ï¼š

```make
ç›®æ ‡: ä¾èµ–
	å‘½ä»¤
```

ä¾‹å¦‚ï¼š

```make
hello.o: hello.c
	gcc -c hello.c -o hello.o
```
å«ä¹‰ï¼šå½“ hello.c æ›´æ–°æ—¶ï¼Œæ‰§è¡Œ gcc -c hello.c -o hello.o ç”Ÿæˆ hello.oã€‚

> make ä¼šè‡ªåŠ¨æ ¹æ®æ–‡ä»¶çš„æ—¶é—´æˆ³åˆ¤æ–­å“ªäº›ç›®æ ‡éœ€è¦é‡æ–°ç”Ÿæˆï¼Œè¿™å°±æ˜¯å®ƒçš„é«˜æ•ˆä¹‹å¤„ã€‚

<!--more-->

# ä¸‰ã€è‡ªåŠ¨å˜é‡

è‡ªåŠ¨å˜é‡æ˜¯ `make` åœ¨æ‰§è¡Œè§„åˆ™æ—¶è‡ªåŠ¨è®¾ç½®çš„ç‰¹æ®Šå˜é‡ã€‚å®ƒä»¬æ ¹æ®å½“å‰è§„åˆ™ä¸­çš„ç›®æ ‡å’Œä¾èµ–åŠ¨æ€èµ‹å€¼ï¼Œä¸éœ€è¦ä½ æ‰‹åŠ¨ä¼ å‚ã€‚

| è‡ªåŠ¨å˜é‡ | å«ä¹‰                             |
|----------|----------------------------------|
| `$@`     | å½“å‰è§„åˆ™çš„ **ç›®æ ‡ï¼ˆTargetï¼‰**    |
| `$<`     | å½“å‰è§„åˆ™çš„ **ç¬¬ä¸€ä¸ªä¾èµ–**        |
| `$^`     | å½“å‰è§„åˆ™çš„ **æ‰€æœ‰ä¾èµ–ï¼ˆå»é‡ï¼‰**  |
| `$+`     | å½“å‰è§„åˆ™çš„ **æ‰€æœ‰ä¾èµ–ï¼ˆä¿ç•™é‡å¤ï¼‰** |
| `$*`     | å»æ‰åç¼€çš„æ–‡ä»¶åï¼ˆstemï¼‰         |
| `$?`     | æ‰€æœ‰**æ¯”ç›®æ ‡æ–°çš„ä¾èµ–é¡¹**         |

## ç¤ºä¾‹è®²è§£

### ç¤ºä¾‹ 1ï¼š`$@` å’Œ `$<`

```make
hello.o: hello.c
	gcc -c $< -o $@
```
ç­‰ä»·äº:

```make
hello.o: hello.c
	gcc -c hello.c -o hello.o
```
### ç¤ºä¾‹ 2ï¼š`$^`ï¼ˆæ‰€æœ‰ä¾èµ–ï¼‰

```make
main: main.o utils.o
	gcc $^ -o $@
```

ç­‰ä»·äºï¼š

```make
main: main.o utils.o
	gcc main.o utils.o -o main
```

### ç¤ºä¾‹ 3ï¼šæ¨¡å¼è§„åˆ™ `%`

```make
%.o: %.c
	gcc -c $< -o $@
```

è¿™ä¸ªæ¨¡å¼è§„åˆ™å¯ä»¥è‡ªåŠ¨åŒ¹é…ï¼š

- `main.o â† main.c`
- `utils.o â† utils.c`

æ­¤æ—¶

- `$*` è¡¨ç¤ºä¸å¸¦æ‰©å±•åçš„ `stem`ï¼Œæ¯”å¦‚ `main`ã€`utils`
- `$<` æ˜¯ `main.c`
- `$@` æ˜¯ `main.o`

### ç¤ºä¾‹ 4ï¼š`$?`ï¼ˆæ¯”ç›®æ ‡æ–°çš„ä¾èµ–ï¼‰

```make
backup.tar: file1 file2
	tar -cf $@ $?
```

å«ä¹‰ï¼š
- `backup.tar` æ˜¯ç›®æ ‡
- `$?` æ˜¯æ‰€æœ‰æ¯” `backup.tar` æ–°çš„æ–‡ä»¶ï¼ˆéœ€è¦é‡æ–°æ‰“åŒ…çš„éƒ¨åˆ†ï¼‰

# å››ã€wildcard / patsubst / basename
é™¤äº†è‡ªåŠ¨å˜é‡ï¼Œ`Makefile` è¿˜æä¾›äº†å¼ºå¤§çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œå¸¸è§çš„æœ‰ `wildcard`ã€`patsubst` å’Œ `basename`ã€‚
å®ƒä»¬å¯ä»¥å¸®åŠ©ä½ å®ç°è‡ªåŠ¨åŒ–æ„å»ºï¼Œè®© `Makefile` æ›´åŠ ç®€æ´å’Œå¯æ‰©å±•ã€‚


## 1. wildcard â€”â€” æŸ¥æ‰¾æ–‡ä»¶
è¯­æ³•ï¼š

```make
$(wildcard pattern...)
```
- PATTERNï¼šæ–‡ä»¶åŒ¹é…æ¨¡å¼ï¼ˆæ”¯æŒ *ã€?ã€[...] ç­‰ shell é£æ ¼çš„é€šé…ç¬¦ï¼‰

- è¿”å›å€¼ï¼šåŒ¹é…åˆ°çš„æ–‡ä»¶ååˆ—è¡¨ï¼ˆä»¥ç©ºæ ¼åˆ†éš”ï¼‰

> ğŸ’¡ ç®€å•æ¥è¯´ï¼Œ`wildcard` ä¼šå» ç£ç›˜ ä¸Šæ‰¾æ–‡ä»¶ï¼Œä¸æ˜¯å¯¹å­—ç¬¦ä¸²åšæ›¿æ¢ï¼Œè€Œæ˜¯ çœŸå®åœ°æŸ¥æ‰¾å­˜åœ¨çš„æ–‡ä»¶ã€‚

ç¤ºä¾‹ï¼š

```make
SRC := $(wildcard *.c)

all:
	@echo $(SRC)
```

å¦‚æœç›®å½•ä¸­æœ‰ï¼š

```css
main.c foo.c bar.c readme.txt
```
è¾“å‡ºï¼š

```css
main.c foo.c bar.c
```

ğŸ’¡ **ä½œç”¨**ï¼šè‡ªåŠ¨æ‰«æåŒ¹é…çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ‰‹å†™æ–‡ä»¶åã€‚

## 2. patsubst â€”â€” æ¨¡å¼æ›¿æ¢
è¯­æ³•ï¼š

```make
$(patsubst pattern,replacement,text)
```

- <pattern>ï¼šè¦åŒ¹é…çš„æ¨¡å¼ï¼ˆæ”¯æŒ `%` é€šé…ç¬¦ï¼‰

- <replacement>ï¼šæ›¿æ¢æˆçš„æ–°æ¨¡å¼ï¼ˆåŒæ ·æ”¯æŒ `%`ï¼‰

- <text>ï¼šè¦è¿›è¡Œæ›¿æ¢çš„ä¸€ç»„å­—ç¬¦ä¸²ï¼ˆä»¥ç©ºæ ¼åˆ†éš”ï¼‰


ç¤ºä¾‹ï¼š

```make

SRC := foo.c bar.c main.c
OBJ := $(patsubst %.c,%.o,$(SRC))

all:
	@echo $(OBJ)
```
è¾“å‡ºï¼š

```css
foo.o bar.o main.o
```

ğŸ’¡ **ä½œç”¨**ï¼šæ‰¹é‡æ›¿æ¢æ–‡ä»¶ååç¼€ï¼Œä¾‹å¦‚ .c â†’ .oã€‚

## 3. basename â€”â€” å»æ‰æ‰©å±•å
è¯­æ³•ï¼š

```make
$(basename names...)
```
ç¤ºä¾‹ï¼š

```make
FILES := foo.c bar.c readme.txt
NAMES := $(basename $(FILES))

all:
	@echo $(NAMES)
```
è¾“å‡ºï¼š

```
foo bar readme
```
ğŸ’¡ **ä½œç”¨**ï¼šè·å–ä¸å¸¦æ‰©å±•åçš„â€œçº¯æ–‡ä»¶åâ€ã€‚

## 4. ä¸‰è€…ç»“åˆçš„è‡ªåŠ¨åŒ–æ„å»º
å‡è®¾ç›®å½•ä¸­æœ‰ï¼š

```
bootstrap.bpf.c bootstrap.c
user_ringbuf.bpf.c user_ringbuf.c
```

æˆ‘ä»¬æƒ³è¦ï¼š

è‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰ `.bpf.c` æ–‡ä»¶

è‡ªåŠ¨å»æ‰æ‰©å±•å

è‡ªåŠ¨ç”Ÿæˆ `.bpf.o` å’Œ `.skel.h` åˆ—è¡¨

```make

PROGRAMS := $(basename $(wildcard *.bpf.c))
BPF_OBJS := $(patsubst %,%.bpf.o,$(PROGRAMS))
SKELS    := $(patsubst %,%.skel.h,$(PROGRAMS))

all:
	@echo "PROGRAMS: $(PROGRAMS)"
	@echo "BPF_OBJS: $(BPF_OBJS)"
	@echo "SKELS: $(SKELS)"
```

æ‰§è¡Œç»“æœï¼š
```makefile
PROGRAMS: bootstrap user_ringbuf
BPF_OBJS: bootstrap.bpf.o user_ringbuf.bpf.o
SKELS: bootstrap.skel.h user_ringbuf.skel.h
```

æ–°å¢ä¸€ä¸ª `trace_connect.bpf.c` åï¼Œ`Makefile` ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ›´æ–°ï¼Œæ— éœ€ä¿®æ”¹å˜é‡ã€‚
